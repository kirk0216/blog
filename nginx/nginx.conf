user nginx;
worker_processes 1;
error_log /dev/stdout info;
error_log off;
pid /var/run/nginx.pid;

events {
   worker_connections 1024;
   use epoll;
   multi_accept on;
}

http {
   include /etc/nginx/mime.types;
   default_type application/octet-stream;
   
   keepalive_timeout 65;
   keepalive_requests 100000;
   tcp_nopush on;
   tcp_nodelay on;

   server {
      proxy_pass_header Server;
      server_name blog.patrickkirk.ca;

      location / {
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_pass http://blog:5050;
      }

      listen [::]:443 ssl ipv6only=on; # managed by Certbot
      listen 443 ssl; # managed by Certbot
      ssl_certificate /etc/letsencrypt/live/www.patrickkirk.ca/fullchain.pem; # managed by Certbot
      ssl_certificate_key /etc/letsencrypt/live/www.patrickkirk.ca/privkey.pem; # managed by Certbot
      include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
      ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
   }

   server {
      if ($host = blog.patrickkirk.ca) {
         return 301 https://$host$request_uri;
      } # managed by Certbot

      listen 80;
      listen [::]:80;
      server_name blog.patrickkirk.ca;
      return 404; # managed by Certbot
   }
}
